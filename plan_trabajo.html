<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Plan de Trabajo por Aplicaci√≥n</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f9;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #2c3e50;
    }
    .app {
      background: #ecf0f1;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 25px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .app h2 {
      margin-top: 0;
      color: #1a5276;
    }
    .server {
      background: #fff;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .server h3 {
      margin-top: 0;
      color: #34495e;
    }
    h4 {
      margin: 10px 0 5px;
      color: #34495e;
      border-bottom: 1px solid #ddd;
      padding-bottom: 3px;
    }
    label {
      display: block;
      margin: 6px 0;
      cursor: pointer;
    }
    progress {
      width: 100%;
      height: 20px;
      margin-top: 5px;
      -webkit-appearance: none;
      appearance: none;
    }
    progress::-webkit-progress-bar {
      background-color: #eee;
      border-radius: 5px;
    }
    progress::-webkit-progress-value {
      border-radius: 5px;
    }
    progress.low::-webkit-progress-value { background: #e74c3c; }
    progress.medium::-webkit-progress-value { background: #f1c40f; }
    progress.high::-webkit-progress-value { background: #2ecc71; }
    textarea {
      width: 100%;
      min-height: 60px;
      margin-top: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      padding: 8px;
      font-family: Arial, sans-serif;
      resize: vertical;
    }
    .total-progress {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .btn {
      display: inline-block;
      margin: 10px 5px 10px 0;
      padding: 8px 15px;
      border: none;
      border-radius: 6px;
      background: #3498db;
      color: #fff;
      cursor: pointer;
    }
    .btn:hover {
      background: #2980b9;
    }
    .server-progress {
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <h1>Plan de Trabajo - WebLogic - Seguros Bolivar</h1>

  <button class="btn" onclick="addApp()">‚ûï Agregar Aplicaci√≥n</button>
  <button class="btn" onclick="exportData()">üíæ Exportar Avance</button>

  <div id="apps"></div>

  <div class="total-progress">
    <h2>Avance Total</h2>
    <div id="progress-summary"></div>
    <h3>Promedio General</h3>
    <p><span id="total-text">0%</span></p>
    <progress id="total-progress" value="0" max="100"></progress>
  </div>

  <script>
    const taskGroups = {
      "Prerrequisitos": [
        "Memoria validada",
        "Discos validados",
        "Versi√≥n de SO verificada",
        "Librer√≠as instaladas",
        "Puertos disponibles"
      ],
      "WebLogic Instalaci√≥n y Configuraci√≥n": [
        "Instalaci√≥n de WebLogic",
        "Configuraci√≥n de Datasources",
        "Configuraci√≥n de JMS",
        "Configuraci√≥n de Cl√∫steres",
        "Certificados SSL",
        "Configuraci√≥n de config.xml",
        "Configuraci√≥n de setDomainEnv.sh",
        "Configuraci√≥n de startWebLogic.sh",
        "Configuraci√≥n de stopWebLogic.sh",
        "Configuraci√≥n de startNodeManager.sh",
        "Configuraci√≥n de stopNodeManager.sh",
        "Configuraci√≥n de nodemanager.domains",
        "Configuraci√≥n de nodemanager.properties",
        "Configuraci√≥n de logging.properties",
        "Configuraci√≥n de usuarios y grupos",
        "Configuraci√≥n de variables de entorno",
        "Apuntamiento hacia BD",
        "Despliegue de aplicaciones"
      ],
      "Post-Instalaci√≥n": [
        "Pruebas de conectividad",
        "Pruebas de rendimiento",
        "Documentaci√≥n actualizada"
      ]
    };

    const groupsToCount = ["Prerrequisitos", "WebLogic Instalaci√≥n y Configuraci√≥n"];

    function addApp(name = "Nueva Aplicaci√≥n") {
      const appsDiv = document.getElementById('apps');
      const appDiv = document.createElement('div');
      appDiv.className = 'app';

      appDiv.innerHTML = `
        <h2>Aplicaci√≥n: <input type="text" value="${name}" placeholder="Nombre de la aplicaci√≥n"></h2>
        <button class="btn" onclick="addServer(this)">‚ûï Agregar Servidor</button>
        <div class="servers"></div>
        <h3>Avance de la Aplicaci√≥n: <span class="app-progress-text">0%</span></h3>
        <progress value="0" max="100" class="app-progress"></progress>
      `;

      appsDiv.appendChild(appDiv);
    }

    function addServer(button, name = "", checks = [], note = "") {
      const serversDiv = button.parentElement.querySelector('.servers');
      const serverDiv = document.createElement('div');
      serverDiv.className = 'server';

      let html = `
        <h3>Servidor: <input type="text" placeholder="Nombre del servidor" value="${name}"></h3>
        <form>`;

      let i = 0;
      for (const [group, tasks] of Object.entries(taskGroups)) {
        html += `<h4>${group}</h4>`;
        tasks.forEach(task => {
          const checked = checks[i] ? "checked" : "";
          const countable = groupsToCount.includes(group) ? "data-countable='true'" : "data-countable='false'";
          html += `<label><input type="checkbox" ${countable} ${checked}> ${task}</label>`;
          i++;
        });
      }

      html += `</form>
        <p>Avance (Capa media): <span class="progress-text">0%</span></p>
        <progress value="0" max="100"></progress>
        <h4>Observaciones</h4>
        <textarea placeholder="Escribe aqu√≠ notas u observaciones...">${note}</textarea>`;
      serverDiv.innerHTML = html;

      serversDiv.appendChild(serverDiv);

      serverDiv.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', () => updateProgress(serverDiv));
      });
      serverDiv.querySelector('input[type="text"]').addEventListener('input', saveState);
      serverDiv.querySelector('textarea').addEventListener('input', saveState);

      updateProgress(serverDiv);
    }

    function updateProgress(serverDiv) {
      const checkboxes = serverDiv.querySelectorAll('input[type="checkbox"][data-countable="true"]');
      const checked = serverDiv.querySelectorAll('input[type="checkbox"][data-countable="true"]:checked');
      const percent = Math.round((checked.length / checkboxes.length) * 100);
      serverDiv.querySelector('.progress-text').textContent = percent + "%";

      const progressBar = serverDiv.querySelector('progress');
      progressBar.value = percent;
      setProgressColor(progressBar, percent);

      updateAppProgress(serverDiv.closest('.app'));
      updateTotalProgress();
      saveState();
    }

    function updateAppProgress(appDiv) {
      const servers = appDiv.querySelectorAll('.server');
      let total = 0, count = 0;
      servers.forEach(server => {
        const percent = parseInt(server.querySelector('.progress-text').textContent);
        total += percent;
        count++;
      });
      const avg = count ? Math.round(total / count) : 0;
      appDiv.querySelector('.app-progress-text').textContent = avg + "%";
      const appBar = appDiv.querySelector('.app-progress');
      appBar.value = avg;
      setProgressColor(appBar, avg);
    }

    function updateTotalProgress() {
      const servers = document.querySelectorAll('.server');
      const summaryDiv = document.getElementById('progress-summary');
      summaryDiv.innerHTML = "";

      let total = 0, count = 0;

      servers.forEach((server, idx) => {
        const name = server.querySelector('input[type="text"]').value || `Servidor ${idx + 1}`;
        const percent = parseInt(server.querySelector('.progress-text').textContent);
        total += percent;
        count++;

        const serverBar = document.createElement('div');
        serverBar.className = 'server-progress';

        const bar = document.createElement('progress');
        bar.value = percent;
        bar.max = 100;
        setProgressColor(bar, percent);

        serverBar.innerHTML = `<p><b>${name}</b>: ${percent}%</p>`;
        serverBar.appendChild(bar);
        summaryDiv.appendChild(serverBar);
      });

      const avg = count ? Math.round(total / count) : 0;
      document.getElementById('total-text').textContent = avg + "%";

      const totalBar = document.getElementById('total-progress');
      totalBar.value = avg;
      setProgressColor(totalBar, avg);
    }

    function setProgressColor(bar, percent) {
      bar.classList.remove("low", "medium", "high");
      if (percent < 50) bar.classList.add("low");
      else if (percent < 80) bar.classList.add("medium");
      else bar.classList.add("high");
    }

    function saveState() {
      const data = [];
      document.querySelectorAll('.app').forEach(app => {
        const appData = {
          name: app.querySelector('input[type="text"]').value,
          servers: []
        };
        app.querySelectorAll('.server').forEach(server => {
          appData.servers.push({
            name: server.querySelector('input[type="text"]').value,
            checks: Array.from(server.querySelectorAll('input[type="checkbox"]')).map(c => c.checked),
            note: server.querySelector('textarea').value
          });
        });
        data.push(appData);
      });
      localStorage.setItem('planTrabajoDinamico', JSON.stringify(data));
    }

    function loadState() {
      const saved = localStorage.getItem('planTrabajoDinamico');
      if (saved) {
        const data = JSON.parse(saved);
        data.forEach(app => {
          addApp(app.name);
          const lastApp = document.querySelector('.app:last-child');
          app.servers.forEach(s => addServer(lastApp.querySelector('button'), s.name, s.checks, s.note));
        });
      }
    }

    loadState();
  </script>
</body>
</html>