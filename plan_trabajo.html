<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Plan de Trabajo - WebLogic - Seguros Bolivar</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f9; padding:20px; }
    h1 { text-align:center; color:#2c3e50; }
    .app { background:#ecf0f1; border-radius:10px; padding:15px; margin-bottom:20px; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
    .app h2 { margin:0 0 8px 0; color:#1a5276; display:flex; gap:10px; align-items:center;}
    .server { background:#fff; border-radius:8px; padding:12px; margin:10px 0; box-shadow:0 1px 4px rgba(0,0,0,0.06); }
    .server h3 { margin:0 0 8px 0; color:#34495e; display:flex; gap:10px; align-items:center;}
    h4 { margin:10px 0 6px 0; color:#34495e; border-bottom:1px solid #ddd; padding-bottom:3px; }
    label { display:block; margin:6px 0; cursor:pointer; }
    progress { width:100%; height:18px; margin-top:6px; -webkit-appearance:none; appearance:none; }
    progress::-webkit-progress-bar { background:#eee; border-radius:5px; }
    progress::-webkit-progress-value { border-radius:5px; }
    progress.low::-webkit-progress-value { background:#e74c3c; }
    progress.medium::-webkit-progress-value { background:#f1c40f; }
    progress.high::-webkit-progress-value { background:#2ecc71; }
    textarea { width:100%; min-height:64px; margin-top:8px; border-radius:6px; border:1px solid #ccc; padding:8px; resize:vertical; font-family:inherit; }
    .btn { display:inline-block; margin:8px 6px 8px 0; padding:8px 14px; border:none; border-radius:6px; background:#3498db; color:#fff; cursor:pointer; }
    .controls { margin-bottom:16px; }
    .total-progress { background:#fff; padding:12px; border-radius:8px; margin-top:16px; box-shadow:0 2px 5px rgba(0,0,0,0.06); }
    .server-progress { margin:8px 0; }
    .chart-container { width: 280px; height: 280px; margin: 20px auto; }
  </style>
</head>
<body>
  <h1>Plan de Trabajo - WebLogic - Seguros Bolivar</h1>

  <div class="controls">
    <button class="btn" onclick="addApp()">‚ûï Agregar Aplicaci√≥n</button>
    <button class="btn" onclick="exportData()">üíæ Exportar Avance</button>
  </div>

  <div id="apps"></div>

  <div class="total-progress">
    <h2>Avance Total</h2>
    <div id="progress-summary"></div>
    <h4>Promedio General</h4>
    <p><span id="total-text">0%</span></p>
    <progress id="total-progress" value="0" max="100"></progress>
  </div>

  <script>
    const taskGroups = {
      "Prerrequisitos": [
        "Memoria validada",
        "Discos validados",
        "Versi√≥n de SO verificada",
        "Librer√≠as instaladas",
        "Puertos disponibles"
      ],
      "WebLogic Instalaci√≥n y Configuraci√≥n": [
        "Instalaci√≥n de WebLogic",
        "Parchado OPatch",
        "Aplicaci√≥n Parche Weblogic",
        "Configuraci√≥n de Datasources",
        "Configuraci√≥n de JMS",
        "Configuraci√≥n de Cl√∫steres",
        "Certificados SSL",
        "Configuraci√≥n de config.xml",
        "Configuraci√≥n de setDomainEnv.sh",
        "Configuraci√≥n de startWebLogic.sh",
        "Configuraci√≥n de stopWebLogic.sh",
        "Configuraci√≥n de startNodeManager.sh",
        "Configuraci√≥n de stopNodeManager.sh",
        "Configuraci√≥n de nodemanager.domains",
        "Configuraci√≥n de nodemanager.properties",
        "Configuraci√≥n de logging.properties",
        "Configuraci√≥n de usuarios y grupos",
        "Configuraci√≥n de variables de entorno",
        "Apuntamiento hacia BD",
        "Despliegue de aplicaciones"
      ],
      "Post-Instalaci√≥n": [
        "Pruebas de conectividad",
        "Pruebas de rendimiento",
        "Documentaci√≥n actualizada"
      ]
    };

    const groupsToCount = ["Prerrequisitos", "WebLogic Instalaci√≥n y Configuraci√≥n"];
    const charts = new Map();

    function addApp(name = "Nueva Aplicaci√≥n") {
      const appsDiv = document.getElementById('apps');
      const appDiv = document.createElement('div');
      appDiv.className = 'app';
      const id = 'chart-' + Math.random().toString(36).slice(2, 9);

      appDiv.innerHTML = `
        <h2>Aplicaci√≥n: <input type="text" value="${escapeHtml(name)}" placeholder="Nombre de la aplicaci√≥n"></h2>
        <button class="btn" onclick="addServer(this)">‚ûï Agregar Servidor</button>
        <div class="servers"></div>
        <div class="chart-container"><canvas id="${id}"></canvas></div>
      `;

      if (appsDiv.firstChild) appsDiv.insertBefore(appDiv, appsDiv.firstChild);
      else appsDiv.appendChild(appDiv);
      appDiv.querySelector('input[type="text"]').addEventListener('input', saveState);

      charts.set(appDiv, new Chart(document.getElementById(id), {
        type: 'pie',
        data: { labels: [], datasets: [{ data: [], backgroundColor: [] }] },
        options: {
          responsive: true,
          plugins: { legend: { position: 'bottom' }, title: { display: true, text: 'Avance por servidor' } }
        }
      }));
    }

    function addServer(button, name = "", checks = [], note = "") {
      const serversDiv = button.parentElement.querySelector('.servers');
      const serverDiv = document.createElement('div');
      serverDiv.className = 'server';

      let html = `<h3>Servidor: <input type="text" placeholder="Nombre del servidor" value="${escapeHtml(name)}"></h3><form>`;
      let i = 0;
      for (const [group, tasks] of Object.entries(taskGroups)) {
        html += `<h4>${escapeHtml(group)}</h4>`;
        tasks.forEach(task => {
          const checked = checks[i] ? "checked" : "";
          const countable = groupsToCount.includes(group) ? "data-countable='true'" : "data-countable='false'";
          html += `<label><input type="checkbox" ${countable} ${checked}> ${escapeHtml(task)}</label>`;
          i++;
        });
      }
      html += `</form>
        <p>Avance (Capa media): <span class="progress-text">0%</span></p>
        <progress value="0" max="100"></progress>
        <h4>Observaciones</h4>
        <textarea placeholder="Escribe aqu√≠ notas u observaciones...">${escapeHtml(note)}</textarea>`;

      serverDiv.innerHTML = html;

      if (serversDiv.firstChild) serversDiv.insertBefore(serverDiv, serversDiv.firstChild);
      else serversDiv.appendChild(serverDiv);

      serverDiv.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.addEventListener('change', () => {
        updateProgress(serverDiv);
        updateTotalProgress();
      }));
      serverDiv.querySelector('input[type="text"]').addEventListener('input', updateTotalProgress);
      serverDiv.querySelector('textarea').addEventListener('input', saveState);

      updateProgress(serverDiv);
      updateTotalProgress();
    }

    function updateProgress(serverDiv) {
      const checkboxes = serverDiv.querySelectorAll('input[type="checkbox"][data-countable="true"]');
      const checked = serverDiv.querySelectorAll('input[type="checkbox"][data-countable="true"]:checked');
      const totalCount = checkboxes.length || 0;
      const percent = totalCount === 0 ? 0 : Math.round((checked.length / totalCount) * 100);
      serverDiv.querySelector('.progress-text').textContent = percent + "%";

      const progressBar = serverDiv.querySelector('progress');
      progressBar.value = percent;
      setProgressColor(progressBar, percent);
      saveState();
    }

    function updateTotalProgress() {
      const servers = document.querySelectorAll('.server');
      const summaryDiv = document.getElementById('progress-summary');
      summaryDiv.innerHTML = "";

      let total = 0, count = 0;
      servers.forEach((server, idx) => {
        const name = server.querySelector('h3 input').value || `Servidor ${idx+1}`;
        const percent = parseInt(server.querySelector('.progress-text').textContent) || 0;
        total += percent; count++;
        const serverBar = document.createElement('div');
        serverBar.className = 'server-progress';
        const bar = document.createElement('progress');
        bar.value = percent; bar.max = 100;
        setProgressColor(bar, percent);
        serverBar.innerHTML = `<p><b>${escapeHtml(name)}</b>: ${percent}%</p>`;
        serverBar.appendChild(bar);
        summaryDiv.appendChild(serverBar);
      });

      const avg = count ? Math.round(total / count) : 0;
      document.getElementById('total-text').textContent = avg + "%";
      const totalBar = document.getElementById('total-progress');
      totalBar.value = avg;
      setProgressColor(totalBar, avg);

      // Actualizar gr√°ficos por app
      document.querySelectorAll('.app').forEach(appDiv => {
        const chart = charts.get(appDiv);
        if (!chart) return;
        const servers = appDiv.querySelectorAll('.server');
        const labels = [], data = [], colors = [];

        servers.forEach(server => {
          const name = server.querySelector('h3 input').value || 'Servidor';
          const percent = parseInt(server.querySelector('.progress-text').textContent) || 0;
          labels.push(name);
          data.push(percent);
          colors.push(percent >= 80 ? '#2ecc71' : percent >= 50 ? '#f1c40f' : '#e74c3c');
        });

        chart.data.labels = labels;
        chart.data.datasets[0].data = data;
        chart.data.datasets[0].backgroundColor = colors;
        chart.update();
      });
    }

    function setProgressColor(bar, percent) {
      bar.classList.remove("low", "medium", "high");
      if (percent < 50) bar.classList.add("low");
      else if (percent < 80) bar.classList.add("medium");
      else bar.classList.add("high");
    }

    function saveState() {
      const data = [];
      document.querySelectorAll('.app').forEach(app => {
        const appData = {
          name: app.querySelector('h2 input').value,
          servers: []
        };
        app.querySelectorAll('.server').forEach(server => {
          appData.servers.push({
            name: server.querySelector('h3 input').value,
            checks: Array.from(server.querySelectorAll('input[type="checkbox"]')).map(c => c.checked),
            note: server.querySelector('textarea').value
          });
        });
        data.push(appData);
      });
      localStorage.setItem('planTrabajoDinamico', JSON.stringify(data));
    }

    function loadState() {
      const saved = localStorage.getItem('planTrabajoDinamico');
      if (!saved) return;
      try {
        const data = JSON.parse(saved);
        for (let ai = data.length - 1; ai >= 0; ai--) {
          const app = data[ai];
          addApp(app.name || 'Aplicaci√≥n');
          const appDiv = document.querySelector('.app:first-child');
          if (!appDiv) continue;
          if (Array.isArray(app.servers)) {
            for (let si = app.servers.length - 1; si >= 0; si--) {
              const s = app.servers[si];
              addServer(appDiv.querySelector('button'), s.name || '', s.checks || [], s.note || '');
            }
          }
        }
        updateTotalProgress();
      } catch (e) { console.warn('Error al cargar plan', e); }
    }

    function escapeHtml(str) {
      return str ? String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])) : '';
    }

    loadState();
    setTimeout(updateTotalProgress, 200);
  </script>
</body>
</html>