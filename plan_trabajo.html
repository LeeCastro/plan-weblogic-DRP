<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Plan de Trabajo - WebLogic - Seguros Bolivar</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f9; padding:20px; }
    h1 { text-align:center; color:#2c3e50; }
    .app { background:#ecf0f1; border-radius:10px; padding:15px; margin-bottom:20px; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
    .app h2 { margin:0 0 8px 0; color:#1a5276; display:flex; gap:10px; align-items:center;}
    .server { background:#fff; border-radius:8px; padding:12px; margin:10px 0; box-shadow:0 1px 4px rgba(0,0,0,0.06); }
    .server h3 { margin:0 0 8px 0; color:#34495e; display:flex; gap:10px; align-items:center;}
    h4 { margin:10px 0 6px 0; color:#34495e; border-bottom:1px solid #ddd; padding-bottom:3px; }
    label { display:block; margin:6px 0; cursor:pointer; }
    progress { width:100%; height:18px; margin-top:6px; -webkit-appearance:none; appearance:none; }
    progress::-webkit-progress-bar { background:#eee; border-radius:5px; }
    progress::-webkit-progress-value { border-radius:5px; }
    progress.low::-webkit-progress-value { background:#e74c3c; }
    progress.medium::-webkit-progress-value { background:#f1c40f; }
    progress.high::-webkit-progress-value { background:#2ecc71; }
    textarea { width:100%; min-height:64px; margin-top:8px; border-radius:6px; border:1px solid #ccc; padding:8px; resize:vertical; font-family:inherit; }
    .btn { display:inline-block; margin:8px 6px 8px 0; padding:8px 14px; border:none; border-radius:6px; background:#3498db; color:#fff; cursor:pointer; }
    .btn.secondary { background:#7f8c8d; }
    .controls { margin-bottom:16px; }
    .total-progress { background:#fff; padding:12px; border-radius:8px; margin-top:16px; box-shadow:0 2px 5px rgba(0,0,0,0.06); }
    .server-progress { margin:8px 0; }
    .note { margin-top:8px; font-style:italic; color:#555; white-space:pre-wrap; }
    input[type="text"] { padding:6px; border-radius:4px; border:1px solid #ccc; }
    .small { font-size:0.9em; color:#666; }
  </style>
</head>
<body>
  <h1>Plan de Trabajo - WebLogic - Seguros Bolivar</h1>

  <div class="controls">
    <button class="btn" onclick="addApp()">âž• Agregar AplicaciÃ³n</button>
    <button class="btn" onclick="exportData()">ðŸ’¾ Exportar Avance (data.json)</button>
    <button class="btn secondary" onclick="bindExistingDataJson()">ðŸ”— Vincular data.json (opcional)</button>
    <span class="small"> (Si vinculas el archivo, las exportaciones intentarÃ¡n sobrescribirlo automÃ¡ticamente.)</span>
  </div>

  <div id="apps"></div>

  <div class="total-progress">
    <h2>Avance Total</h2>
    <div id="progress-summary"></div>
    <h4>Promedio General</h4>
    <p><span id="total-text">0%</span></p>
    <progress id="total-progress" value="0" max="100"></progress>
  </div>

  <script>
    /***********************
     * ConfiguraciÃ³n
     ***********************/
    const taskGroups = {
      "Prerrequisitos": [
        "Memoria validada",
        "Discos validados",
        "VersiÃ³n de SO verificada",
        "LibrerÃ­as instaladas",
        "Puertos disponibles"
      ],
      "WebLogic InstalaciÃ³n y ConfiguraciÃ³n": [
        "InstalaciÃ³n de WebLogic",
        "ConfiguraciÃ³n de Datasources",
        "ConfiguraciÃ³n de JMS",
        "ConfiguraciÃ³n de ClÃºsteres",
        "Certificados SSL",
        "ConfiguraciÃ³n de config.xml",
        "ConfiguraciÃ³n de setDomainEnv.sh",
        "ConfiguraciÃ³n de startWebLogic.sh",
        "ConfiguraciÃ³n de stopWebLogic.sh",
        "ConfiguraciÃ³n de startNodeManager.sh",
        "ConfiguraciÃ³n de stopNodeManager.sh",
        "ConfiguraciÃ³n de nodemanager.domains",
        "ConfiguraciÃ³n de nodemanager.properties",
        "ConfiguraciÃ³n de logging.properties",
        "ConfiguraciÃ³n de usuarios y grupos",
        "ConfiguraciÃ³n de variables de entorno",
        "Apuntamiento hacia BD",
        "Despliegue de aplicaciones"
      ],
      "Post-InstalaciÃ³n": [
        "Pruebas de conectividad",
        "Pruebas de rendimiento",
        "DocumentaciÃ³n actualizada"
      ]
    };

    // SÃ³lo estos grupos cuentan para el % (se excluye Post-InstalaciÃ³n)
    const groupsToCount = ["Prerrequisitos", "WebLogic InstalaciÃ³n y ConfiguraciÃ³n"];

    /***********************
     * IndexedDB para FileHandle (File System Access)
     ***********************/
    function openHandlesDB() {
      return new Promise((resolve, reject) => {
        if (!window.indexedDB) return reject(new Error('IndexedDB no disponible'));
        const req = indexedDB.open('plan-work-handles', 1);
        req.onupgradeneeded = (e) => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains('handles')) db.createObjectStore('handles');
        };
        req.onsuccess = (e) => resolve(e.target.result);
        req.onerror = (e) => reject(e);
      });
    }

    async function storeFileHandle(handle) {
      try {
        const db = await openHandlesDB();
        return new Promise((resolve, reject) => {
          const tx = db.transaction('handles', 'readwrite');
          const store = tx.objectStore('handles');
          const r = store.put(handle, 'dataJson');
          r.onsuccess = () => resolve();
          r.onerror = (e) => reject(e);
        });
      } catch (err) {
        console.warn('storeFileHandle error', err);
      }
    }

    async function getStoredFileHandle() {
      try {
        const db = await openHandlesDB();
        return new Promise((resolve, reject) => {
          const tx = db.transaction('handles', 'readonly');
          const store = tx.objectStore('handles');
          const r = store.get('dataJson');
          r.onsuccess = () => resolve(r.result);
          r.onerror = () => resolve(null);
        });
      } catch (err) {
        return null;
      }
    }

    /***********************
     * UI: Agregar App / Servidor (inserciÃ³n al inicio)
     ***********************/
    function addApp(name = "Nueva AplicaciÃ³n") {
      const appsDiv = document.getElementById('apps');
      const appDiv = document.createElement('div');
      appDiv.className = 'app';

      appDiv.innerHTML = `
        <h2>AplicaciÃ³n: <input type="text" value="${escapeHtml(name)}" placeholder="Nombre de la aplicaciÃ³n"></h2>
        <button class="btn" onclick="addServer(this)">âž• Agregar Servidor</button>
        <div class="servers"></div>
      `;

      // Insertar al inicio
      if (appsDiv.firstChild) appsDiv.insertBefore(appDiv, appsDiv.firstChild);
      else appsDiv.appendChild(appDiv);

      // Guardar estado cuando se cambie el nombre de la app
      appDiv.querySelector('input[type="text"]').addEventListener('input', saveState);
    }

    function addServer(button, name = "", checks = [], note = "") {
      const serversDiv = button.parentElement.querySelector('.servers');
      const serverDiv = document.createElement('div');
      serverDiv.className = 'server';

      // construir formulario de tareas
      let html = `<h3>Servidor: <input type="text" placeholder="Nombre del servidor" value="${escapeHtml(name)}"></h3><form>`;
      let i = 0;
      for (const [group, tasks] of Object.entries(taskGroups)) {
        html += `<h4>${escapeHtml(group)}</h4>`;
        tasks.forEach(task => {
          const checked = checks[i] ? "checked" : "";
          const countable = groupsToCount.includes(group) ? "data-countable='true'" : "data-countable='false'";
          html += `<label><input type="checkbox" ${countable} ${checked}> ${escapeHtml(task)}</label>`;
          i++;
        });
      }
      html += `</form>
        <p>Avance (Capa media): <span class="progress-text">0%</span></p>
        <progress value="0" max="100"></progress>
        <h4>Observaciones</h4>
        <textarea placeholder="Escribe aquÃ­ notas u observaciones...">${escapeHtml(note)}</textarea>`;

      serverDiv.innerHTML = html;

      // Insertar al inicio de la lista de servidores
      if (serversDiv.firstChild) serversDiv.insertBefore(serverDiv, serversDiv.firstChild);
      else serversDiv.appendChild(serverDiv);

      // Listeners
      serverDiv.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.addEventListener('change', () => {
        updateProgress(serverDiv);
        updateTotalProgress();
      }));
      serverDiv.querySelector('input[type="text"]').addEventListener('input', saveState);
      serverDiv.querySelector('textarea').addEventListener('input', saveState);

      // calcular progreso inicial
      updateProgress(serverDiv);
      updateTotalProgress();
    }

    /***********************
     * CÃ¡lculo y UI de progreso
     ***********************/
    function updateProgress(serverDiv) {
      const checkboxes = serverDiv.querySelectorAll('input[type="checkbox"][data-countable="true"]');
      const checked = serverDiv.querySelectorAll('input[type="checkbox"][data-countable="true"]:checked');
      const totalCount = checkboxes.length || 0;
      const percent = totalCount === 0 ? 0 : Math.round((checked.length / totalCount) * 100);
      const pctTextEl = serverDiv.querySelector('.progress-text');
      if (pctTextEl) pctTextEl.textContent = percent + "%";

      const progressBar = serverDiv.querySelector('progress');
      if (progressBar) {
        progressBar.value = percent;
        setProgressColor(progressBar, percent);
      }

      saveState();
    }

    function updateTotalProgress() {
      const servers = document.querySelectorAll('.server');
      const summaryDiv = document.getElementById('progress-summary');
      summaryDiv.innerHTML = "";

      let total = 0, count = 0;
      servers.forEach((server, idx) => {
        const nameInput = server.querySelector('h3 input');
        const name = nameInput ? (nameInput.value || `Servidor ${idx+1}`) : `Servidor ${idx+1}`;
        const percent = parseInt(server.querySelector('.progress-text')?.textContent) || 0;
        total += percent;
        count++;

        const serverBar = document.createElement('div');
        serverBar.className = 'server-progress';
        const bar = document.createElement('progress');
        bar.value = percent;
        bar.max = 100;
        setProgressColor(bar, percent);
        serverBar.innerHTML = `<p><b>${escapeHtml(name)}</b>: ${percent}%</p>`;
        serverBar.appendChild(bar);
        summaryDiv.appendChild(serverBar);
      });

      const avg = count ? Math.round(total / count) : 0;
      document.getElementById('total-text').textContent = avg + "%";
      const totalBar = document.getElementById('total-progress');
      totalBar.value = avg;
      setProgressColor(totalBar, avg);
    }

    function setProgressColor(bar, percent) {
      bar.classList.remove("low", "medium", "high");
      if (percent < 50) bar.classList.add("low");
      else if (percent < 80) bar.classList.add("medium");
      else bar.classList.add("high");
    }

    /***********************
     * Guardar / Cargar en localStorage
     ***********************/
    function saveState() {
      const data = [];
      document.querySelectorAll('.app').forEach(app => {
        const appName = app.querySelector('h2 input') ? app.querySelector('h2 input').value : '';
        const appData = { name: appName, servers: [] };
        app.querySelectorAll('.server').forEach(server => {
          const serverName = server.querySelector('h3 input') ? server.querySelector('h3 input').value : '';
          const checks = Array.from(server.querySelectorAll('input[type="checkbox"]')).map(c => c.checked);
          const progress = parseInt(server.querySelector('.progress-text')?.textContent) || 0;
          const note = server.querySelector('textarea') ? server.querySelector('textarea').value : '';
          appData.servers.push({ name: serverName, checks, progress, note });
        });
        data.push(appData);
      });
      localStorage.setItem('planTrabajoDinamico', JSON.stringify(data));
      // TambiÃ©n actualizar el panel de resumen
      updateTotalProgress();
    }

    function loadState() {
      const saved = localStorage.getItem('planTrabajoDinamico');
      if (!saved) return;
      try {
        const data = JSON.parse(saved);
        // Para respetar el orden guardado y porque addApp/addServer insertan al inicio,
        // iteramos desde el final al inicio (reverse) para reconstruir igual visualmente.
        for (let ai = data.length - 1; ai >= 0; ai--) {
          const app = data[ai];
          addApp(app.name || 'AplicaciÃ³n');
          // la app reciÃ©n creada estÃ¡ en el primer lugar (inicio)
          const appDiv = document.querySelector('.app:first-child');
          if (!appDiv) continue;
          // agregar servidores en reverse tambiÃ©n para preservar orden interno
          if (Array.isArray(app.servers)) {
            for (let si = app.servers.length - 1; si >= 0; si--) {
              const s = app.servers[si];
              addServer(appDiv.querySelector('button'), s.name || '', s.checks || [], s.note || '');
            }
          }
        }
        updateTotalProgress();
      } catch (e) {
        console.warn('Error al cargar plan desde localStorage', e);
      }
    }

    /***********************
     * Exportar data.json (intento sobrescribir handle guardado)
     ***********************/
    async function exportData() {
      // construir estructura apps -> servers
      const data = [];
      document.querySelectorAll('.app').forEach(app => {
        const appName = app.querySelector('h2 input') ? app.querySelector('h2 input').value : '';
        const appData = { name: appName, servers: [] };
        app.querySelectorAll('.server').forEach(server => {
          const sName = server.querySelector('h3 input') ? server.querySelector('h3 input').value : '';
          const checks = Array.from(server.querySelectorAll('input[type="checkbox"]')).map(c => c.checked);
          const progress = parseInt(server.querySelector('.progress-text')?.textContent) || 0;
          const note = server.querySelector('textarea') ? server.querySelector('textarea').value : '';
          appData.servers.push({ name: sName, checks, progress, note });
        });
        data.push(appData);
      });

      const jsonData = JSON.stringify(data, null, 2);

      // Intento con File System Access API
      if (window.showSaveFilePicker) {
        try {
          // intentar usar handle almacenado
          const storedHandle = await getStoredFileHandle();
          if (storedHandle) {
            // pedir permiso si hace falta
            try {
              const permission = await storedHandle.queryPermission({ mode: 'readwrite' });
              if (permission !== 'granted') {
                const reqPerm = await storedHandle.requestPermission({ mode: 'readwrite' });
                if (reqPerm !== 'granted') throw new Error('Permiso de escritura denegado');
              }
              const writable = await storedHandle.createWritable();
              await writable.write(jsonData);
              await writable.close();
              saveState();
              alert('âœ… data.json sobrescrito correctamente (handle almacenado).');
              return;
            } catch (err) {
              console.warn('No se pudo escribir en el handle almacenado:', err);
              // seguimos para pedir nuevo archivo
            }
          }

          // pedir al usuario dÃ³nde guardar y almacenar handle
          const handle = await window.showSaveFilePicker({
            suggestedName: 'data.json',
            types: [{ description: 'JSON', accept: { 'application/json': ['.json'] } }]
          });
          if (handle) {
            const writable = await handle.createWritable();
            await writable.write(jsonData);
            await writable.close();
            try { await storeFileHandle(handle); } catch(e){ console.warn('No se pudo guardar handle', e); }
            saveState();
            alert('âœ… data.json guardado y handle almacenado. PrÃ³ximas exportaciones lo sobrescribirÃ¡n.');
            return;
          }
        } catch (err) {
          console.warn('Error usando File System Access API:', err);
          // fallback
        }
      }

      // Fallback descarga
      const blob = new Blob([jsonData], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'data.json';
      a.click();
      URL.revokeObjectURL(url);
      saveState();
      alert('âœ… Se descargÃ³ data.json (fallback).');
    }

    /***********************
     * Vincular data.json existente (opcional)
     ***********************/
    async function bindExistingDataJson() {
      if (!window.showOpenFilePicker) {
        alert('Tu navegador no soporta la funciÃ³n de vincular archivos (File System Access API).');
        return;
      }
      try {
        const [handle] = await window.showOpenFilePicker({
          multiple: false,
          types: [{ description: 'JSON', accept: { 'application/json': ['.json'] } }]
        });
        if (handle) {
          // guardar el handle para futuras sobreescrituras
          try { await storeFileHandle(handle); } catch(e){ console.warn('No se pudo almacenar handle', e); }
          alert('âœ… data.json vinculado. Las prÃ³ximas exportaciones intentarÃ¡n sobrescribir este archivo.');
        }
      } catch (err) {
        console.warn('bindExistingDataJson error', err);
      }
    }

    /***********************
     * Helpers
     ***********************/
    function escapeHtml(str) {
      if (!str && str !== '') return '';
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    /***********************
     * Inicio
     ***********************/
    loadState();
    // actualizar resumen en inicio
    setTimeout(updateTotalProgress, 200);
  </script>
</body>
</html>